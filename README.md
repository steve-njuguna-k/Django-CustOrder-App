# Django Custumser Order App
A Django Customer Order App, built on PostgreSQL database &amp; with API endpoints using DjangoRestFramework. Authentication &amp; Authorization is through OpenID Connect. CICD pipeline is done through CircleCI and deployment is on AWS through CloudFormation.

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/AWS-API-ENDPOINT.png)

# App Database
The customer model. It consists of a unique UUID, First Name, Last Name, Phone Number, Date Created & Date Modified
```
class Customer(models.Model):
    uuid = models.UUIDField(default=uuid.uuid4, editable=False, unique=True)
    first_name = models.CharField(max_length=250, verbose_name='First Name', null=False, blank=False)
    last_name = models.CharField(max_length=250, verbose_name='Last Name', null=False, blank=False)
    phone_number = models.CharField(max_length=250, verbose_name='Phone Number', null=False, blank=False)
    date_created = models.DateTimeField(verbose_name='Date Created',auto_now_add=True)
    date_modified = models.DateTimeField(verbose_name='Date Modified',auto_now=True)
```

The Item model. It consists of a unique UUID, Item Name, Item Size, Item Price, Date Created & Date Modified
```
class Item(models.Model):
    uuid = models.UUIDField(default=uuid.uuid4, editable=False, unique=True)
    name = models.CharField(max_length=250, verbose_name='Name', null=False, blank=False)
    size = models.TextField(verbose_name='Size', choices=SIZES, null=False, blank=False)
    price = models.DecimalField(max_digits=10, decimal_places=2, verbose_name='Price', null=False, blank=False)
    date_created = models.DateTimeField(verbose_name='Date Created',auto_now_add=True)
    date_modified = models.DateTimeField(verbose_name='Date Modified',auto_now=True)
```

The Order model.. It consists of a unique UUID, Customer (FK), Item (FK), Quantity, Date Created & Date Modified. The total is calculated using the quantity & price
```
class Order(models.Model):
    uuid = models.UUIDField(default=uuid.uuid4, editable=False, unique=True)
    customer = models.ForeignKey('Customers.Customer', on_delete=models.PROTECT, verbose_name='Customer', null=False, blank=False)
    item = models.ForeignKey('Items.Item', on_delete=models.PROTECT, verbose_name='Item', null=False, blank=False)
    quantity = models.PositiveIntegerField(verbose_name='Quantity', null=False, blank=False)
    date_created = models.DateTimeField(verbose_name='Date Created',auto_now_add=True)
    date_modified = models.DateTimeField(verbose_name='Date Modified',auto_now=True)

    def _get_order_item_total(self):
        return self.item.price * self.quantity
    
    total = property(_get_order_item_total)
```

# API Endpoints
The API endpoints provide CRUD functionalities for authenticated & authorized users.
```
{
  "Title": "Customer Endpoints",
  "Create A Customer": "[POST] /v1/customers",
  "List Customers": "[GET] /v1/customers",
  "Get Customer Details": "[GET] /v1/customers/:id",
  "Update Customer Details": "[PATCH] /v1/customers/:id",
  "Delete Customer Details": "[DELETE] /v1/customers/:id",
}, {
  "Title": "Item Endpoints",
  "Create An Item": "[POST] /v1/items",
  "List Items": "[GET] /v1/items",
  "Get Item Details": "[GET] /v1/items/:id",
  "Update Item Details": "[PATCH] /v1/items/:id",
  "Delete Item Details": "[DELETE] /v1/items/:id",
}, {
  "Title": "Order Endpoints",
  "Create An Order": "[POST] /v1/orders",
  "List Orders": "[GET] /v1/orders",
  "Get Order Details": "[GET] /v1/orders/:id",
  "Update Order Details": "[PATCH] /v1/orders/:id",
  "Delete Order Details": "[DELETE] /v1/orders/:id",
}
```

# OpenID Connect Authentication & Authorization
I used the Django Admin login for authentication. Create a superuser:
```
python manage.py createsuperuser

Username: wiliam
Email address: me@wiliam.dev
Password:
Password (again):
Superuser created successfully.
```

Start the development server
```
python manage.py runserver
```

Head over to <YOUR_IP_ADDRESS>/o/applications/register/ to create an application. If you are logged in, it  will take directly to create an app, otherwise you need to login first. Copy the autogenerated CLIENT ID & CLIENT SECRET for later use.

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/APPLICATION-CREATION.png)

After creating an app, you will be redirected to show all you app details.

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/APPLICATION-DETAILS.png)

To generate an authentication code grant with PKCE (Proof Key for Code Exchange), useful to preventing authorization code injection, you must first generate a CODE VERIFIER random string between 43 and 128 characters, which is then encoded to produce a CODE CHALLENGE.
```
import random
import string
import base64
import hashlib

code_verifier = ''.join(random.choice(string.ascii_uppercase + string.digits) for _ in range(random.randint(43, 128)))
code_verifier = base64.urlsafe_b64encode(code_verifier.encode('utf-8'))

code_challenge = hashlib.sha256(code_verifier).digest()
code_challenge = base64.urlsafe_b64encode(code_challenge).decode('utf-8').replace('=', '')
```

Copy the autogenerated CODE VERIFIER & CODE CHALLENGE for later use.

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/CODE-VERIFIER-&-CODE-CHALLENGE-GENERATION.png)

To start the Authorization code flow go to authorize URL
```
<YOUR_IP_ADDRESS>/o/authorize/?response_type=code&code_challenge=CODE_CHALLENGE&code_challenge_method=S256&client_id=CLIENT_ID&redirect_uri=REDIRECT_URI
```

Note the parameters we pass:
```
•	response_type: code
•	code_challenge: CODE-CHALLENGE
•	code_challenge_method: S256
•	client_id: CLIENT_ID
•	redirect_uri: http://127.0.0.1:8000/o/callback
```

This identifies your application, the user is asked to authorize your application to access its resources. Go ahead and authorize the app

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/AUTHORIZATION-CONSENT-SCREEN.png)

The REDIRECT_URI will redirect to you another page to get the authorization code. This is the OAuth2 provider trying to give you a code.

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/AUTHORIZATIO-CODE-GENERATION.png)

Now that you have the user authorization code, you can get an Access Token. Using CURL, head over to PostMan and initiate a POST request
```
curl -X POST \
    -H "Cache-Control: no-cache" \
    -H "Content-Type: application/x-www-form-urlencoded" \
    "http://127.0.0.1:8000/o/token/" \
    -d "client_id=${ID}" \
    -d "client_secret=${SECRET}" \
    -d "code=${CODE}" \
    -d "code_verifier=${CODE_VERIFIER}" \
    -d "redirect_uri=http://127.0.0.1:8000/noexist/callback" \
    -d "grant_type=authorization_code"
```

The OAuth2 provider will return the follow response

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/ACCESS-TOKEN-GENERATION.png)

You can now use the ACCESS TOKEN to gain access to protected API endpoints such as:

Create a Customer

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/CUSTOMER-CREATION.png)

Create a Item

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/ITEM-CREATION.png)

Create an Order

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/ORDER-CREATION.png)

Upon creating an Order, using the AfricasTalkiing Simulator, you will receive an SMS for order confirmation

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/SMS-SIMULATOR-RESULT.png)

# CircleCI Pipeline
The CI/CD pipeline is made up 4 main stages

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/PIPELINE.png)

### Build Test Stage
This stage is where the application packages are installed and all testcases are ensured to be compliant

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/BUILD-TEST.png)

The test cases results

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/TEST-RESULTS.png)

### Test Coverage
This is where the test coverage report is created to show what percentage of the entire code is properly tested

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/TEST-COVERAGE.png)

The test coverage results

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/COVERAGE-REPORT.png)

### Push To DockerHub
This is where a Docker image is built then push to DockerHub

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/PUSH-TO-DOCKERHUB.png)

The DockerHub Image

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/DOCKER-HUB-REPO.png)

### Deploy EC2 Instance
This is where an AWS EC2 instance is deployed using CloudFormation

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/DEPLOY-EC2-INSTANCE.png)

The CloudFormation Deployment Result

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/CLOUDFORMATION-DEPLOYMENT.png)

The EC2 Server

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/EC2-SERVER.png)

Accessing The Application API Endpoint at <AWS_EC2_INSTANCE_PUBLIC_IP>/api

![](https://github.com/steve-njuguna-k/Django-CustOrder-App/blob/master/Screenshots/AWS-API-ENDPOINT.png)

© 2023 Steve Njuguna
